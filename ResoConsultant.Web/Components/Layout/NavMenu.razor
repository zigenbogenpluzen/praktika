@using MudBlazor
@using MudBlazor.Services
@inject AiApiClient AiClient
@inject ISnackbar Snackbar

<PageTitle>РЕСО Чат</PageTitle>

<MudContainer MaxWidth="MaxWidth.Medium"
              Class="d-flex flex-column"
              Style="height: calc(100vh - 80px); padding-top: 16px; padding-bottom: 16px;">
    
    <!-- Окно чата -->
    <MudPaper Elevation="1"
              Class="flex-grow-1 pa-4 overflow-auto d-flex flex-column gap-3 mb-4 scroll-smooth"
              Style="background: rgba(255,255,255,0.92); border-radius: 24px; border: 1px solid rgba(0,0,0,0.03);">
        
        @if (messages.Count == 0)
        {
            <div class="d-flex flex-column align-center justify-center h-100 opacity-50">
                <MudIcon Icon="@Icons.Material.Filled.MedicalServices" Size="Size.Large" Style="width: 80px; height: 80px; color: #009444;"/>
                <MudText Typo="Typo.h6" Class="mt-4" Style="font-weight: 600;">Привет! Я помощник РЕСО-Мед.</MudText>
                <MudText Typo="Typo.body2">Спросите меня о страховке или полисе ОМС.</MudText>
            </div>
        }

        @foreach (var msg in messages)
        {
            <div class="d-flex w-100 @(msg.IsUser ? "justify-end" : "justify-start") animate-fade-in">
                <!-- Аватарка бота -->
                @if (!msg.IsUser)
                {
                    <MudAvatar Size="Size.Small" Color="Color.Primary" Class="mr-2 mt-1" Style="font-size: 12px;">AI</MudAvatar>
                }

                <!-- Пузырь сообщения -->
                <div class="pa-3 px-4 elevation-1" 
                     style="@GetBubbleStyle(msg.IsUser)">
                    <MudText Typo="Typo.body1" Style="line-height: 1.5;">@msg.Text</MudText>
                    <MudText Typo="Typo.caption" 
                             Style="@(msg.IsUser ? "color: rgba(255,255,255,0.7);" : "color: #8E8E93;")" 
                             Class="mt-1 d-block text-right">
                        @msg.Time
                    </MudText>
                </div>
            </div>
        }

        @if (isThinking)
        {
            <div class="d-flex justify-start ml-9 animate-pulse">
                <div class="pa-3 px-4 rounded-xl" style="background: #FFFFFF; border: 1px solid #E5E5EA;">
                    <MudText Typo="Typo.body2" Color="Color.Secondary">Печатает...</MudText>
                </div>
            </div>
        }
    </MudPaper>

    <!-- Поле ввода (Floating Bar) -->
    <MudPaper Elevation="6" Class="pa-2 rounded-pill d-flex align-center gap-2"
              Style="background: rgba(255,255,255,0.96); backdrop-filter: blur(16px); border: 1px solid rgba(0,0,0,0.06);">
        
        <MudIconButton Icon="@Icons.Material.Outlined.AddCircle" Color="Color.Default" Class="ml-1"/>
        
        <input @bind="userInput" @bind:event="oninput" @onkeydown="HandleKeyDown"
               placeholder="Введите ваш вопрос..." 
               style="flex-grow: 1;
                      border: none;
                      background: transparent;
                      outline: none;
                      padding: 10px 4px;
                      font-size: 16px;
                      color: #1C1C1E;" />

        <MudIconButton Icon="@Icons.Material.Filled.ArrowUpward" 
                       Variant="Variant.Filled" 
                       Color="Color.Primary" 
                       Size="Size.Medium"
                       Class="mr-1 rounded-circle"
                       OnClick="SendMessage" 
                       Disabled="@(string.IsNullOrWhiteSpace(userInput) || isThinking)"
                       Style="background: linear-gradient(135deg, #009444 0%, #007A33 100%); box-shadow: 0 4px 12px rgba(0, 148, 68, 0.3);"/>
    </MudPaper>

</MudContainer>

<style>
    /* Анимации для плавности */
    .animate-fade-in { animation: fadeIn 0.3s ease-out forwards; }
    @@keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    .scroll-smooth { scroll-behavior: smooth; }
</style>

@code {
    private string userInput = string.Empty;
    private bool isThinking = false;
    private readonly List<Message> messages = new();

    class Message
    {
        public string Text { get; set; } = string.Empty;
        public bool IsUser { get; set; }
        public string Time { get; set; } = string.Empty;
    }

    private string GetBubbleStyle(bool isUser)
    {
        // Дизайн пузырей: Apple iMessage style
        if (isUser)
        {
            // Градиентный изумрудный, скругление, белый текст
            return "background: linear-gradient(135deg, #009444 0%, #006B31 100%); color: white; border-radius: 18px 18px 4px 18px; max-width: 75%;";
        }
        else
        {
            // Белый фон, темный текст, мягкая тень
            return "background: #FFFFFF; color: #1C1C1E; border-radius: 18px 18px 18px 4px; max-width: 75%; border: 1px solid #E5E5EA;";
        }
    }

    private async Task HandleKeyDown(KeyboardEventArgs e)
    {
        if (e.Key == "Enter" && !string.IsNullOrWhiteSpace(userInput) && !isThinking) await SendMessage();
    }

    private async Task SendMessage()
    {
        var text = userInput;
        userInput = ""; // Моментально очищаем
        messages.Add(new Message { Text = text, IsUser = true, Time = DateTime.Now.ToShortTimeString() });
        isThinking = true;
        StateHasChanged(); // Принудительно обновляем UI

        var response = await AiClient.AskAsync(text);

        isThinking = false;
        
        if (response.IsSuccess)
        {
            messages.Add(new Message { Text = response.Answer, IsUser = false, Time = DateTime.Now.ToShortTimeString() });
        }
        else
        {
            Snackbar.Add($"Ошибка: {response.ErrorMessage}", Severity.Error);
            messages.Add(new Message { Text = "Извините, сейчас я не могу ответить.", IsUser = false, Time = DateTime.Now.ToShortTimeString() });
        }
    }
}
